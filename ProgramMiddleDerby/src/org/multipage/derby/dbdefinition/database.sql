-- Creates Multipage database


CREATE FUNCTION GET_LOCALIZED_TEXT (TEXT_ID BIGINT, LANGUAGE_ID BIGINT)
RETURNS VARCHAR (32672)
PARAMETER STYLE JAVA
READS SQL DATA LANGUAGE JAVA
EXTERNAL NAME 'org.multipage.derby.DerbyFunctions.getLocalizedText';




CREATE TABLE APP.DESCRIPTION (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 1) NOT NULL,
	DESCRIPTION VARCHAR (8192) NOT NULL,
	PRIMARY KEY (ID)
);



CREATE TABLE APP.ENUMERATION (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 1) NOT NULL,
	DESCRIPTION VARCHAR(255) NOT NULL,
	PRIMARY KEY (DESCRIPTION)
);

ALTER TABLE APP.ENUMERATION ADD UNIQUE (ID);




CREATE TABLE APP.ENUMERATION_VALUE (
	ENUMERATION_ID BIGINT NOT NULL,
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 1) NOT NULL,
	ENUM_VALUE VARCHAR(255) NOT NULL,
	DESCRIPTION VARCHAR(255),
	PRIMARY KEY (ENUMERATION_ID, ENUM_VALUE)
);

ALTER TABLE APP.ENUMERATION_VALUE
	ADD FOREIGN KEY (ENUMERATION_ID) 
	REFERENCES APP.ENUMERATION (ID);
	
ALTER TABLE APP.ENUMERATION_VALUE ADD UNIQUE (ID);




CREATE TABLE APP.NAMESPACE (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 0) NOT NULL,
	DESCRIPTION VARCHAR(255) NOT NULL,
	PARENT_ID BIGINT NOT NULL,
	PRIMARY KEY (ID)
);

ALTER TABLE APP.NAMESPACE
	ADD FOREIGN KEY (PARENT_ID) 
	REFERENCES APP.NAMESPACE (ID);
	

INSERT INTO APP.NAMESPACE (ID, DESCRIPTION, PARENT_ID) VALUES (DEFAULT, '/', 0);



CREATE TABLE APP.MIME_TYPE (
	ID BIGINT GENERATED ALWAYS AS IDENTITY NOT NULL,
	EXTENSION VARCHAR(25) NOT NULL,
	TYPE VARCHAR(255) NOT NULL,
	PREFERENCE BOOLEAN DEFAULT false NOT NULL,
	PRIMARY KEY (EXTENSION,TYPE)
);

ALTER TABLE APP.MIME_TYPE ADD UNIQUE (ID);



CREATE TABLE APP.RESOURCE (
	ID BIGINT GENERATED ALWAYS AS IDENTITY NOT NULL,
	NAMESPACE_ID BIGINT DEFAULT 0 NOT NULL,
	DESCRIPTION VARCHAR(255),
	MIME_TYPE_ID BIGINT DEFAULT 0 NOT NULL,
	VISIBLE BOOLEAN,
	PROTECTED BOOLEAN DEFAULT false NOT NULL,
	BLOB BLOB(2147483647),
	TEXT CLOB,
	PRIMARY KEY (ID)
);


ALTER TABLE APP.RESOURCE
	ADD FOREIGN KEY (MIME_TYPE_ID) 
	REFERENCES APP.MIME_TYPE (ID);

ALTER TABLE APP.RESOURCE
	ADD FOREIGN KEY (NAMESPACE_ID) 
	REFERENCES APP.NAMESPACE (ID);



CREATE TABLE APP.TEXT_ID (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 0) NOT NULL,
	PRIMARY KEY (ID)
);

INSERT INTO APP.TEXT_ID (ID) VALUES (DEFAULT);

INSERT INTO APP.TEXT_ID (ID) VALUES (DEFAULT);




CREATE TABLE APP.LANGUAGE (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 0) NOT NULL,
	DESCRIPTION VARCHAR(255) NOT NULL,
	ALIAS VARCHAR(255) NOT NULL CONSTRAINT LANGUAGE_UC UNIQUE,
	ICON BLOB(2147483647),
	PRIORITY INTEGER DEFAULT 0 NOT NULL,
	PRIMARY KEY (ID)
);

INSERT INTO APP.LANGUAGE (ID, DESCRIPTION, ALIAS, ICON) VALUES (DEFAULT, 'Default', 'def', NULL);



CREATE TABLE APP.START_LANGUAGE (
	LANGUAGE_ID BIGINT NOT NULL,
	PRIMARY KEY (LANGUAGE_ID)
);

ALTER TABLE APP.START_LANGUAGE
	ADD FOREIGN KEY (LANGUAGE_ID) 
	REFERENCES APP.LANGUAGE (ID);

INSERT INTO APP.START_LANGUAGE (LANGUAGE_ID) VALUES (0);



CREATE TABLE APP.LOCALIZED_TEXT (
	TEXT_ID BIGINT NOT NULL,
	LANGUAGE_ID BIGINT NOT NULL,
	TEXT VARCHAR(32672),
	PRIMARY KEY (LANGUAGE_ID,TEXT_ID)
);

ALTER TABLE APP.LOCALIZED_TEXT
	ADD FOREIGN KEY (LANGUAGE_ID) 
	REFERENCES APP.LANGUAGE (ID);

ALTER TABLE APP.LOCALIZED_TEXT
	ADD FOREIGN KEY (TEXT_ID) 
	REFERENCES APP.TEXT_ID (ID);

INSERT INTO APP.LOCALIZED_TEXT (TEXT_ID, LANGUAGE_ID, TEXT) VALUES (0, 0, 'Basic Area');

INSERT INTO APP.LOCALIZED_TEXT (TEXT_ID, LANGUAGE_ID, TEXT) VALUES (1, 0, 'Default');




CREATE TABLE APP.VERSION (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 0) NOT NULL,
	ALIAS VARCHAR(255) CONSTRAINT VERSION_ALIAS_UC UNIQUE,
	DESCRIPTION_ID BIGINT,
	PRIMARY KEY (ID)
);

ALTER TABLE APP.VERSION
	ADD FOREIGN KEY (DESCRIPTION_ID) 
	REFERENCES APP.TEXT_ID (ID);
	
INSERT INTO APP.VERSION (ALIAS, DESCRIPTION_ID) VALUES ('def', 1);




CREATE TABLE APP.CONSTRUCTOR_GROUP (
  ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 1) NOT NULL,
  EXTENSION_AREA_ID BIGINT,
  ALIAS VARCHAR(50),
  PRIMARY KEY (ID)
);




CREATE TABLE APP.AREA (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 0) NOT NULL,
	GUID CHAR(16) FOR BIT DATA,
	START_RESOURCE BIGINT,
	DESCRIPTION_ID BIGINT,
	VISIBLE BOOLEAN DEFAULT true NOT NULL,
	ALIAS VARCHAR(4096),
	READ_ONLY BOOLEAN DEFAULT true NOT NULL,
	HELP VARCHAR(32672),
	LOCALIZED BOOLEAN DEFAULT true NOT NULL,
	FILENAME VARCHAR(255),
	VERSION_ID BIGINT,
	FOLDER VARCHAR(4096),
	CONSTRUCTORS_GROUP_ID BIGINT,
	CONSTRUCTOR_HOLDER_ID BIGINT,
	START_RESOURCE_NOT_LOCALIZED BOOLEAN,
	RELATED_AREA_ID BIGINT,
	FILE_EXTENSION VARCHAR(20),
	CAN_IMPORT BOOLEAN,
	PROJECT_ROOT BOOLEAN,
	ENABLED BOOLEAN DEFAULT true,
	PRIMARY KEY (ID)
);

ALTER TABLE APP.AREA
	ADD FOREIGN KEY (START_RESOURCE) 
	REFERENCES APP.RESOURCE (ID);

ALTER TABLE APP.AREA
	ADD FOREIGN KEY (DESCRIPTION_ID) 
	REFERENCES APP.TEXT_ID (ID);
	
ALTER TABLE APP.AREA
	ADD FOREIGN KEY (VERSION_ID)
	REFERENCES APP.VERSION (ID);
    
ALTER TABLE APP.AREA
    ADD FOREIGN KEY (CONSTRUCTORS_GROUP_ID)
    REFERENCES APP.CONSTRUCTOR_GROUP (ID);

ALTER TABLE APP.AREA
	ADD CONSTRAINT AREA_CHECK CHECK (NOT (START_RESOURCE IS NULL AND VERSION_ID IS NOT NULL));
	
ALTER TABLE APP.AREA
	ADD FOREIGN KEY (RELATED_AREA_ID) 
	REFERENCES APP.AREA (ID);
	
ALTER TABLE APP.CONSTRUCTOR_GROUP
	ADD FOREIGN KEY (EXTENSION_AREA_ID)
	REFERENCES APP.AREA(ID);
	
INSERT INTO APP.AREA (ID, START_RESOURCE, DESCRIPTION_ID, VISIBLE, ALIAS, READ_ONLY, HELP, LOCALIZED, CAN_IMPORT)
              VALUES (DEFAULT, NULL, 0, FALSE, NULL, TRUE, NULL, FALSE, TRUE);




CREATE TABLE APP.AREA_RESOURCE (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 1) NOT NULL,
	AREA_ID BIGINT NOT NULL,
	RESOURCE_ID BIGINT NOT NULL,
	LOCAL_DESCRIPTION VARCHAR(255),
	PRIMARY KEY (AREA_ID, RESOURCE_ID, LOCAL_DESCRIPTION)
);

ALTER TABLE APP.AREA_RESOURCE
	ADD FOREIGN KEY (AREA_ID) 
	REFERENCES APP.AREA (ID);

ALTER TABLE APP.AREA_RESOURCE
	ADD FOREIGN KEY (RESOURCE_ID) 
	REFERENCES APP.RESOURCE (ID);




CREATE TABLE APP.IS_SUBAREA (
	AREA_ID BIGINT NOT NULL,
	SUBAREA_ID BIGINT NOT NULL,
	INHERITANCE BOOLEAN DEFAULT false NOT NULL,
	ID BIGINT GENERATED ALWAYS AS IDENTITY NOT NULL,
	PRIORITY_SUB INTEGER DEFAULT 0 NOT NULL,
	PRIORITY_SUPER INTEGER DEFAULT 0 NOT NULL,
	NAME_SUB VARCHAR(1024),
	NAME_SUPER VARCHAR(1024),
	HIDE_SUB BOOLEAN DEFAULT false NOT NULL,
	RECURSION BOOLEAN DEFAULT false NOT NULL,
	PRIMARY KEY (AREA_ID,SUBAREA_ID)
);

ALTER TABLE APP.IS_SUBAREA
	ADD FOREIGN KEY (SUBAREA_ID) 
	REFERENCES APP.AREA (ID);

ALTER TABLE APP.IS_SUBAREA
	ADD FOREIGN KEY (AREA_ID) 
	REFERENCES APP.AREA (ID);

ALTER TABLE APP.IS_SUBAREA
  ADD CONSTRAINT IS_SUBAREA_RECURSION_CHECK
  CHECK (RECURSION AND NOT INHERITANCE AND HIDE_SUB OR NOT RECURSION);


  
  
CREATE TABLE APP.AREA_SLOT (
	ALIAS VARCHAR(255) NOT NULL,
	AREA_ID BIGINT NOT NULL,
	REVISION INT DEFAULT 0 NOT NULL,
	CREATED TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
	LOCALIZED_TEXT_VALUE_ID BIGINT,
	TEXT_VALUE VARCHAR(32672),
	INTEGER_VALUE BIGINT,
	REAL_VALUE DOUBLE,
	ID BIGINT GENERATED ALWAYS AS IDENTITY NOT NULL,
	ACCESS CHAR(1) DEFAULT 'T' NOT NULL,
	HIDDEN BOOLEAN DEFAULT false NOT NULL,
	BOOLEAN_VALUE BOOLEAN,
	ENUMERATION_VALUE_ID BIGINT,
	COLOR BIGINT,
	DESCRIPTION_ID BIGINT,
	IS_DEFAULT BOOLEAN DEFAULT false NOT NULL,
	NAME VARCHAR(100),
	VALUE_MEANING CHAR(3),
	USER_DEFINED BOOLEAN,
	PREFERRED BOOLEAN,
	SPECIAL_VALUE VARCHAR(255),
	AREA_VALUE BIGINT,
	EXTERNAL_PROVIDER VARCHAR(1024),
	EXTERNAL_CHANGE BOOLEAN,
	READS_INPUT BOOLEAN,
	INPUT_LOCK BOOLEAN,
	WRITES_OUTPUT BOOLEAN,
	OUTPUT_LOCK BOOLEAN,
	OUTPUT_TEXT VARCHAR(32672),
	EXPOSED BOOLEAN,
	PRIMARY KEY (ALIAS,AREA_ID, REVISION)
);

ALTER TABLE APP.AREA_SLOT
	ADD FOREIGN KEY (AREA_ID) 
	REFERENCES APP.AREA (ID);
	
ALTER TABLE APP.AREA_SLOT
	ADD FOREIGN KEY (AREA_VALUE) 
	REFERENCES APP.AREA (ID);

ALTER TABLE APP.AREA_SLOT
	ADD FOREIGN KEY (LOCALIZED_TEXT_VALUE_ID) 
	REFERENCES APP.TEXT_ID (ID);
	
ALTER TABLE APP.AREA_SLOT
	ADD FOREIGN KEY (ENUMERATION_VALUE_ID) 
	REFERENCES APP.ENUMERATION_VALUE (ID);
	
ALTER TABLE APP.AREA_SLOT
	ADD FOREIGN KEY (DESCRIPTION_ID)
	REFERENCES APP.DESCRIPTION (ID);
	
CREATE INDEX APP.AREA_SLOT_INDEX_AREA_ID_IS_DEFAULT
	ON APP.AREA_SLOT (AREA_ID, IS_DEFAULT);
	
CREATE INDEX APP.AREA_SLOT_INDEX_AREA_VALUE
	ON APP.AREA_SLOT (AREA_VALUE);




CREATE TABLE APP.START_AREA (
	AREA_ID BIGINT NOT NULL,
	PRIMARY KEY (AREA_ID)
);

ALTER TABLE APP.START_AREA
	ADD FOREIGN KEY (AREA_ID) 
	REFERENCES APP.AREA (ID);

INSERT INTO APP.START_AREA (AREA_ID) VALUES (0);




CREATE TABLE APP.CONSTRUCTOR_HOLDER (
	ID BIGINT GENERATED ALWAYS AS IDENTITY (START WITH 1) NOT NULL,
	AREA_ID BIGINT NOT NULL,
	GROUP_ID BIGINT NOT NULL,
	SUBGROUP_ID BIGINT,
	NAME VARCHAR(255) NOT NULL,
	INHERITANCE BOOLEAN DEFAULT false NOT NULL,
	SUB_RELATION_NAME VARCHAR(255),
	SUPER_RELATION_NAME VARCHAR(255),
	IS_SUB_REFERENCE BOOLEAN,
	ASK_RELATED_AREA BOOLEAN DEFAULT false NOT NULL,
	SUBGROUP_ALIASES VARCHAR(255),
	INVISIBLE BOOLEAN DEFAULT false,
	ALIAS VARCHAR(255),
	SET_HOME BOOLEAN,
	CONSTRUCTOR_LINK BIGINT,
	PRIMARY KEY (ID)
);

ALTER TABLE APP.CONSTRUCTOR_HOLDER
	ADD FOREIGN KEY (AREA_ID) 
	REFERENCES APP.AREA (ID);
	
ALTER TABLE APP.CONSTRUCTOR_HOLDER
	ADD FOREIGN KEY (GROUP_ID) 
	REFERENCES APP.CONSTRUCTOR_GROUP (ID);
	
ALTER TABLE APP.CONSTRUCTOR_HOLDER
	ADD FOREIGN KEY (SUBGROUP_ID) 
	REFERENCES APP.CONSTRUCTOR_GROUP (ID);
		
ALTER TABLE APP.CONSTRUCTOR_HOLDER
	ADD FOREIGN KEY (CONSTRUCTOR_LINK) 
	REFERENCES APP.CONSTRUCTOR_HOLDER (ID);
	
ALTER TABLE APP.CONSTRUCTOR_HOLDER
	ADD CONSTRAINT CONSTRUCTOR_HOLDER_LINK_CHECK CHECK (NOT CONSTRUCTOR_LINK = ID);

			
ALTER TABLE APP.AREA
	ADD FOREIGN KEY (CONSTRUCTOR_HOLDER_ID) 
	REFERENCES APP.CONSTRUCTOR_HOLDER (ID);
	
	
	
	
CREATE TABLE APP.AREA_SOURCES (
	AREA_ID BIGINT NOT NULL,
	RESOURCE_ID BIGINT NOT NULL,
	VERSION_ID BIGINT NOT NULL,
	NOT_LOCALIZED BOOLEAN DEFAULT false NOT NULL,
	PRIMARY KEY (AREA_ID, RESOURCE_ID, VERSION_ID)
);

ALTER TABLE APP.AREA_SOURCES
	ADD FOREIGN KEY (AREA_ID)
	REFERENCES APP.AREA (ID);

ALTER TABLE APP.AREA_SOURCES
	ADD FOREIGN KEY (RESOURCE_ID)
	REFERENCES APP.RESOURCE(ID);
	
ALTER TABLE APP.AREA_SOURCES
	ADD FOREIGN KEY (VERSION_ID)
	REFERENCES APP.VERSION(ID);
	